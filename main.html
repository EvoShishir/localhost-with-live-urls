<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Scripts imports -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
    <!-- <script src="/script.js"></script> -->

    <script>
      var domain = localStorage.getItem("domain") || "http://127.0.0.1:5500/";
      function includeHTML() {
        var z, i, elmnt, file, xhttp;
        z = document.getElementsByTagName("*");
        for (i = 0; i < z.length; i++) {
          elmnt = z[i];
          file = elmnt.getAttribute("w3-include-html");
          if (file) {
            xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
              if (this.readyState == 4) {
                if (this.status == 200) {
                  elmnt.innerHTML = this.responseText;
                  updateImageSources(elmnt);
                  updatePictureSrcset(elmnt);
                  updateAnchorSources(elmnt);
                }
                if (this.status == 404) {
                  elmnt.innerHTML = "Page not found.";
                }
                elmnt.removeAttribute("w3-include-html");
                includeHTML(); // Recursively process includes
              }
            };
            xhttp.open("GET", file, true);
            xhttp.send();
            document.getElementById("autocomplete").value = domain;

            return;
          }
        }
      }

      function updateImageSources(container) {
        const images = container.querySelectorAll("img[src^='/']");
        images.forEach((img) => {
          img.src = domain + img.getAttribute("src");
        });
      }

      function updatePictureSrcset(container) {
        const sources = container.querySelectorAll("source[srcset^='/']");
        sources.forEach((source) => {
          source.srcset = domain + source.getAttribute("srcset");
        });
      }

      function updateAnchorSources(container) {
        const anchors = container.querySelectorAll("a[href^='/']");
        anchors.forEach((anchor) => {
          anchor.href = domain + anchor.getAttribute("href");
        });
      }

      window.addEventListener("beforeunload", function () {
        localStorage.setItem("scrollPosition", window.scrollY);
      });

      window.addEventListener("load", function () {
        setTimeout(() => {
          const scrollPosition = localStorage.getItem("scrollPosition");
          if (scrollPosition !== null) {
            window.scrollTo(0, parseInt(scrollPosition, 10));
          }

          // Set domain input field from stored domain
          const domainInput = document.getElementById("domainInput");
          if (domainInput) {
            domainInput.value = domain;
          }
        }, 100);
      });

      async function fetchWebsiteData() {
        try {
          const response = await fetch(
            "https://page-format-server.vercel.app/website"
          );
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          const siteDomains = data.map(
            (item) => item.id.replace(/_/g, "-") + ".com"
          );
          $("#autocomplete").autocomplete({
            source: siteDomains,
            select: function (event, ui) {
              updateDomain(ui.item.value);
            },
          });
        } catch (error) {
          console.error("Error fetching data:", error);
        }
      }

      // Call the function
      fetchWebsiteData();
      function updateDomain(newDomain) {
        if (!newDomain.startsWith("http")) {
          newDomain = "https://" + newDomain;
        }

        if (!newDomain.endsWith("/")) {
          newDomain += "/";
        }

        domain = newDomain;
        localStorage.setItem("domain", domain); // Persist domain
        window.location.reload();
        includeHTML(); // Re-include content with new domain
      }
    </script>

    <!-- Stylesheets imports -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.3/themes/smoothness/jquery-ui.css"
    />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="customStyle.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.0/css/font-awesome.css"
      integrity="sha512-72McA95q/YhjwmWFMGe8RI3aZIMCTJWPBbV8iQY3jy1z9+bi6+jHnERuNrDPo/WGYEzzNs4WdHNyyEr/yXJ9pA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <title>Local</title>
  </head>

  <body>
    <div class="text-center mt-5">
      <label for="autocomplete">Enter Domain: </label>
      <input id="autocomplete" style="width: 20em" />
      <hr class="mt-5" />
    </div>

    <div w3-include-html="index.html"></div>

    <script>
      includeHTML();
    </script>
  </body>
</html>
