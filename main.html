<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Local Page Viewer</title>

    <!-- Stylesheet imports -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.3/themes/smoothness/jquery-ui.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="styles.css" />
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --accent-color: #f59e0b;
        --background-color: #0f172a;
        --surface-color: #1e293b;
        --surface-light: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #64748b;
        --border-color: #475569;
        --glass-bg: rgba(67, 74, 85, 0.24);
        --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
      }

      /* Header Styles */
      .nav-head {
        position: sticky;
        top: 0;
        z-index: 1000;
        backdrop-filter: blur(5px);
        background: var(--glass-bg);
        box-shadow: var(--shadow-lg);
        font-size: 13px;
      }

      .nav-container {
        max-width: 1250px;
        margin: 0 auto;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-items {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
      }

      /* Search Input */
      .search-container {
        position: relative;
        flex: 1;
        max-width: 350px;
      }

      #autocomplete-input {
        width: 350px;
        padding: 5px 15px;
        background: var(--surface-color);
        border: 2px solid var(--border-color);
        border-radius: 20px;
        color: var(--text-primary);
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      #autocomplete-input:focus {
        outline: none;
        border-color: #348c40;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        background: var(--surface-light);
      }

      #autocomplete-input::placeholder {
        color: var(--text-muted);
      }

      /* Modern Buttons */
      .btns {
        position: relative;
        padding: 0.75rem 1.5rem;
        border-radius: 20px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
        overflow: hidden;
      }

      .btns::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #2c0349a1, #861b697c);
        transition: left 0.5s ease;
      }

      .btns:hover::before {
        left: 100%;
      }

      .btns-primary {
        background: linear-gradient(135deg, #2c0349a1, #861b697c);
        color: white;
        box-shadow: var(--shadow-xl);
      }

      a.btns-primary {
        color: white;
      }

      .btns-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 25px 50px -12px rgba(99, 102, 241, 0.25);
      }

      .btns-secondary {
        background: var(--surface-color);
        color: #10b981;
        border: 2px solid #10b981;
      }

      .btns-secondary:hover {
        background: #10b981;
        color: white;
        transform: translateY(-2px);
      }

      /* Class Pills */
      .class-pills {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .class-pill {
        padding: 0.5rem 1rem;
        background: rgba(147, 147, 147, 0.48);
        border-radius: 20px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .class-pill::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #10b981, #348c40);
        opacity: 0;
        transition: opacity 0.3s ease;
        border-radius: inherit;
      }

      .class-pill:hover {
        transform: translateY(-1px);
        border-color: #10b981;
        color: white;
      }

      .class-pill:hover::before {
        opacity: 1;
      }

      .class-pill span {
        position: relative;
        z-index: 1;
      }

      .class-pill:active {
        transform: scale(0.95);
      }

      /* Image Loader */
      .loader svg {
        width: 40px;
        transform-origin: center;
        animation: rotate4 2s linear infinite;
      }

      .loader circle {
        fill: none;
        stroke: hsl(214, 97%, 59%);
        stroke-width: 5;
        stroke-dasharray: 1, 200;
        stroke-dashoffset: 0;
        stroke-linecap: round;
        animation: dash4 1.5s ease-in-out infinite;
      }

      @keyframes rotate4 {
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes dash4 {
        0% {
          stroke-dasharray: 1, 200;
          stroke-dashoffset: 0;
        }
        50% {
          stroke-dasharray: 90, 200;
          stroke-dashoffset: -35px;
        }
        100% {
          stroke-dashoffset: -125px;
        }
      }

      .error-state {
        text-align: center;
        color: #ef4444;
        padding: 2rem;
      }

      .error-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.7;
      }

      /* Autocomplete Dropdown Styles */
      .ui-menu {
        z-index: 9999;
        background: var(--surface-color);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        backdrop-filter: blur(20px);
        max-height: 300px;
        overflow-y: auto;
        margin-top: 0.5rem;
      }

      .ui-menu-item {
        margin: 0;
      }

      .ui-menu-item .ui-menu-item-wrapper {
        padding: 0.75rem 1rem;
        color: var(--text-secondary);
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: 8px;
        margin: 0.25rem;
      }

      .ui-menu-item .ui-menu-item-wrapper:hover,
      .ui-menu-item .ui-menu-item-wrapper.ui-state-active {
        background: linear-gradient(135deg, #348c40, #786a21);
        color: white;
        margin: 0.25rem;
        transform: translateX(4px);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .nav-container {
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
        }

        .nav-items {
          width: 100%;
          justify-content: center;
        }

        .search-container {
          max-width: 100%;
        }

        .class-pills {
          justify-content: center;
        }

        main {
          padding: 1rem;
        }
      }

      /* Toast Notification */
      .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: #10b981;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 10000;
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <div class="nav-head">
      <div class="nav-container">
        <form id="domain-form">
          <div class="search-container">
            <input
              id="autocomplete-input"
              placeholder="Enter or select a domain..."
            />
          </div>
        </form>
        <div class="nav-items">
          <div class="class-pills" id="domain-classes-container">
            <a id="styles-link" class="btns btns-primary" target="_blank">
              <i class="fas fa-palette"></i>
              Styles
            </a>
          </div>
        </div>
      </div>
    </div>

    <main>
      <div w3-include-html="index.html"></div>
    </main>

    <div id="toast" class="toast"></div>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- STATE MANAGEMENT ---
        let domain = localStorage.getItem("domain") || "http://127.0.0.1:5500/";
        let domainClasses =
          JSON.parse(localStorage.getItem("domainClasses")) || {};
        const siteDomainMap = new Map();

        // --- DOM ELEMENTS ---
        const domainForm = document.getElementById("domain-form");
        const domainInput = document.getElementById("autocomplete-input");
        const classContainer = document.getElementById(
          "domain-classes-container"
        );
        const stylesLink = document.getElementById("styles-link");
        const contentContainer = document.querySelector("[w3-include-html]");
        const toast = document.getElementById("toast");

        // --- HELPER FUNCTIONS ---
        function showToast(message, type = "success") {
          toast.textContent = message;
          toast.className = `toast show ${type}`;
          setTimeout(() => {
            toast.classList.remove("show");
          }, 3000);
        }

        function copyToClipboard(event) {
          const target = event.target;
          const textToCopy =
            target.querySelector("span")?.textContent || target.textContent;

          navigator.clipboard
            .writeText(textToCopy)
            .then(() => {
              showToast("Copied to clipboard!");
              target.style.transform = "scale(0.95)";
              setTimeout(() => {
                target.style.transform = "";
              }, 150);
            })
            .catch((err) => {
              console.error("Failed to copy:", err);
              showToast("Failed to copy", "error");
            });
        }

        function updateImageSources(container) {
          container.querySelectorAll("img[src^='/']").forEach((img) => {
            const loader = document.createElement("div");
            loader.className =
              "d-flex justify-content-center align-items-center py-5 loader";
            loader.innerHTML = `
              <svg viewBox="25 25 50 50">
                <circle r="20" cy="50" cx="50"></circle>
              </svg>
            `;
            img.style.display = "none";
            img.parentNode.insertBefore(loader, img);
            img.onload = () => {
              loader.remove();
              img.style.display = "";
            };
            img.onerror = () => {
              loader.remove();
              img.style.display = "";
            };
            img.src = domain + img.getAttribute("src");
          });
        }

        function updatePictureSrcset(container) {
          container
            .querySelectorAll("source[srcset^='/']")
            .forEach((source) => {
              source.srcset = domain + source.getAttribute("srcset");
            });
        }

        function updateAnchorSources(container) {
          container.querySelectorAll("a[href^='/']").forEach((anchor) => {
            anchor.href = domain + anchor.getAttribute("href");
            anchor.target = "_blank";
          });

          const favicon = document.querySelector('link[rel="shortcut icon"]');
          if (favicon) {
            favicon.href = domain + "/images/favicon.ico";
          }
        }

        function renderDynamicUI() {
          classContainer.innerHTML = `
            <a id="styles-link" class="btns btns-primary" target="_blank">
              <i class="fas fa-palette"></i>
              Styles
            </a>
          `;

          const keysToShow = [
            "bgColor",
            "btnClasses",
            "commonSecClass",
            "heading_class",
            "imgBox",
            "ulClass",
          ];

          if (domainClasses) {
            keysToShow.forEach((key) => {
              if (domainClasses.hasOwnProperty(key)) {
                const pill = document.createElement("div");
                pill.className = "class-pill";
                pill.onclick = copyToClipboard;

                const value = Array.isArray(domainClasses[key])
                  ? JSON.stringify(domainClasses[key])
                  : domainClasses[key];

                pill.innerHTML = `<span>${value}</span>`;
                classContainer.insertBefore(pill, classContainer.firstChild);
              }
            });
          }

          document.getElementById("styles-link").href =
            domain + "/inc/style.css";
          domainInput.value = domain;

          // Update document title
          let title = domain.replace(/^https?:\/\//, "");
          title = title.replace(/\.\w+$/, "");
          document.title = title.charAt(0).toUpperCase() + title.slice(1);
        }

        async function loadAndProcessContent() {
          const fileToInclude =
            contentContainer.getAttribute("w3-include-html");
          if (!fileToInclude) return;

          try {
            const response = await fetch(fileToInclude);
            if (!response.ok)
              throw new Error(`Page not found: ${response.statusText}`);

            const content = await response.text();
            contentContainer.innerHTML = content;

            updateImageSources(contentContainer);
            updatePictureSrcset(contentContainer);
            updateAnchorSources(contentContainer);

            showToast("Content loaded successfully!");
          } catch (error) {
            console.error("Error including HTML:", error);
            contentContainer.innerHTML = `
              <div class="error-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error Loading Content</h3>
                <p>${error.message}</p>
              </div>
            `;
            showToast("Failed to load content", "error");
          }
        }

        async function initializeAutocomplete() {
          try {
            const response = await fetch(
              "https://page-format-server.vercel.app/website"
            );
            if (!response.ok)
              throw new Error(`HTTP error! Status: ${response.status}`);

            const data = await response.json();
            const autocompleteSource = data.map((item) => {
              const originalDomain = item.id;
              const formattedDomain = (
                item.id.endsWith(".com") ? item.id : `${item.id}.com`
              ).replace(/_/g, "-");

              siteDomainMap.set(formattedDomain, originalDomain);

              return {
                label: formattedDomain,
                value: formattedDomain,
                original: originalDomain,
              };
            });

            $("#autocomplete-input").autocomplete({
              source: autocompleteSource,
              select: (event, ui) => {
                event.preventDefault();
                handleDomainUpdate(ui.item.value, ui.item.original);
              },
            });
          } catch (error) {
            console.error(
              "Error fetching website data for autocomplete:",
              error
            );
            showToast("Failed to load autocomplete data", "error");
          }
        }

        async function fetchWebsiteClasses(originalDomain) {
          try {
            const response = await fetch(
              `https://page-format-server.vercel.app/website/${originalDomain}`
            );
            if (!response.ok)
              throw new Error(`HTTP error! Status: ${response.status}`);
            return await response.json();
          } catch (error) {
            console.error("Error fetching website classes:", error);
            throw error;
          }
        }

        async function handleDomainUpdate(newDomainValue, originalDomain) {
          if (!newDomainValue || !originalDomain) return;

          let newDomainUrl = newDomainValue;
          if (!newDomainUrl.startsWith("http")) {
            newDomainUrl = "https://" + newDomainUrl;
          }

          domain = newDomainUrl;
          localStorage.setItem("domain", domain);

          try {
            showToast("Loading domain data...");
            domainClasses = await fetchWebsiteClasses(originalDomain);
            localStorage.setItem(
              "domainClasses",
              JSON.stringify(domainClasses)
            );

            renderDynamicUI();
            await loadAndProcessContent();
          } catch (error) {
            showToast("Failed to load data for the selected domain", "error");
          }
        }

        // Event Listeners
        domainForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const inputValue = domainInput.value.trim();
          let newDomainUrl = inputValue;

          if (!newDomainUrl.startsWith("http")) {
            newDomainUrl = "https://" + newDomainUrl;
          }

          domain = newDomainUrl;
          localStorage.setItem("domain", domain);

          const originalDomain = siteDomainMap.get(inputValue);

          if (originalDomain) {
            // Fetch classes from backend for known domains
            try {
              domainClasses = await fetchWebsiteClasses(originalDomain);
              localStorage.setItem(
                "domainClasses",
                JSON.stringify(domainClasses)
              );
            } catch {
              domainClasses = {};
            }
          } else {
            // Allow unknown domains with empty class data
            domainClasses = {};
            localStorage.setItem("domainClasses", "{}");
          }

          renderDynamicUI();
          await loadAndProcessContent();
          showToast("Domain loaded!");
        });

        window.addEventListener("beforeunload", () => {
          localStorage.setItem("scrollPosition", window.scrollY);
        });

        // Initialization
        async function init() {
          renderDynamicUI();
          await initializeAutocomplete();
          await loadAndProcessContent();

          setTimeout(() => {
            const scrollPosition = localStorage.getItem("scrollPosition");
            if (scrollPosition) {
              window.scrollTo(0, parseInt(scrollPosition, 10));
            }
          }, 200);
        }

        init();

        // FAQ/Details functionality
        document
          .querySelectorAll(".details-block")
          .forEach((targetFaqBlock) => {
            const details = targetFaqBlock.querySelectorAll("details");

            details.forEach((targetDetail) => {
              targetDetail.addEventListener("click", () => {
                details.forEach((detail) => {
                  if (detail !== targetDetail) {
                    detail.removeAttribute("open");
                  }
                });
              });
            });
          });
      });
    </script>
  </body>
</html>
